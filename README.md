# kubernetes fluentd
Collects logs from your nodejs application, assumed you use winston like [this](https://github.com/waleedsamy/hello-world-expressjs-docker) project.

[![Docker Hub](https://img.shields.io/badge/docker-ready-blue.svg)](https://registry.hub.docker.com/u/waleedsamy/k8s-fluentd-nodejs-winston/)

#### How it works
It parse logs generated by your nodejs application (using winston), these logs exist in `/var/log/containers/*`, which is managed by kubernetes.

your log message will look like `{"log":"message","stream":"stdout","time":"2016-10-04T11:31:02.492951101Z"}`. but `log` entry must have a json object, otherwise it will be ignored by current fluentd configuration.

#### build
```bash
  $ docker build -t k8s-fluentd-nodejs-winston . && \
   docker run -d -p 24224:24224 -p 24231:24231 k8s-fluentd-nodejs-winston
```

#### Usage
```bash
  $ docker run -d -p 24224:24224 -p 24231:24231 \
      -e ELASTICSEARCH_HOST=elasticsearch \
      -e ELASTICSEARCH_PORT=9200 \
      -e SLACK_CHANNEL=general \
      -e SLACK_WEBHOOK_URL=https://hooks.slack.com/services/XXX/XXX/XXX \
      waleedsamy/k8s-fluentd-nodejs-winston:logs-router-slack
```

#### Notes
* Elasticsearch Host and port are configured with environment variables `ELASTICSEARCH_HOST` and `ELASTICSEARCH_PORT`, and both have a default value `elasticsearch` and `9200` respectively.
* Slack is configured by `SLACK_WEBHOOK_URL` and `SLACK_CHANNEL`
* Fluentd configuration is based on [gcp-fluentd](https://github.com/kubernetes/kubernetes/tree/master/cluster/addons/fluentd-gcp/fluentd-gcp-image) and [fabric8io/docker-fluentd-kubernetes](https://hub.docker.com/r/fabric8/fluentd-kubernetes)
* Fluentd exclude kubernetes logs which start with `kube` or `k8s`
* json_in_string parser is based on [fluentd-elasticsearch-container](https://github.com/oosidat/fluentd-elasticsearch-container/blob/master/plugins/json_in_string.rb)
